<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>血壓量測辨識系統</title>
</head>
<body>

    <h1>血壓量測辨識</h1>
    <p>請上傳照片自動辨識，或手動輸入數據後存入雲端表格。</p>

    <div>
        <input type="file" id="photoInput" accept="image/*" onchange="previewImage()">
        <br><br>
        <img id="bp-preview" style="max-width: 300px; display: none; border: 1px solid #ccc;">
    </div>

    <div style="margin-top: 10px;">
        <button id="recognizeBtn" style="display: none;" onclick="uploadImage()">開始辨識照片</button>
        <p id="bp-result" style="color: blue; font-weight: bold;"></p>
    </div>

    <hr>

    <div>
        <h3>數據輸入</h3>
        <label>收縮壓 (SYS): </label>
        <input id="sys" type="number" placeholder="例如: 120"><br><br>
        
        <label>舒張壓 (DIA): </label>
        <input id="dia" type="number" placeholder="例如: 80"><br><br>
        
        <label>心跳 (Pulse): </label>
        <input id="pulse" type="number" placeholder="例如: 72"><br><br>
        
        <button onclick="submitData()">送出資料</button>
    </div>

    <p id="msg" style="font-weight: bold;"></p>

    <script>
        // 設定網址 (延用你原本的 API 地址)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxHTZy9uzpaJaXvw9teu7sPhNvTe6JGmFr9pRFrgQzfgjqL9Tg0YeiyS5Mlc9X45eO1Bw/exec";
        const NETLIFY_API = "https://teal-cat-c6ed71.netlify.app/.netlify/functions/recognize";

        // 圖片預覽功能
        function previewImage() {
            const file = document.getElementById('photoInput').files[0];
            const preview = document.getElementById('bp-preview');
            const btn = document.getElementById('recognizeBtn');
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    btn.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // 圖片辨識功能 (呼叫 Netlify API)
        async function uploadImage() {
            const file = document.getElementById('photoInput').files[0];
            const resultDiv = document.getElementById('bp-result');
            if (!file) return;

            resultDiv.innerText = "⏳ 辨識中...";
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Data = reader.result.split(',')[1];
                try {
                    const response = await fetch(NETLIFY_API, {
                        method: 'POST',
                        body: JSON.stringify({ image: base64Data, mimeType: file.type })
                    });
                    const data = await response.json();
                    resultDiv.innerText = "辨識結果：" + data.text;
                    
                    // 自動解析字串並填入數值 (假設格式為 SYS/DIA)
                    if (data.text.includes('/')) {
                        const parts = data.text.split('/');
                        document.getElementById("sys").value = parts[0].replace(/[^0-9]/g, '');
                        document.getElementById("dia").value = parts[1].replace(/[^0-9]/g, '');
                    }
                } catch (error) { 
                    resultDiv.innerText = "❌ 辨識失敗，請手動輸入。"; 
                    console.error(error);
                }
            };
        }

        // 送出資料到 Google Sheets
        async function submitData() {
            const msg = document.getElementById("msg");
            const data = {
                sys: document.getElementById("sys").value,
                dia: document.getElementById("dia").value,
                pulse: document.getElementById("pulse").value
            };

            if (!data.sys || !data.dia) return alert("請填寫收縮壓與舒張壓");

            msg.style.color = "blue";
            msg.innerText = "⏳ 上傳中並取得判斷結果...";

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // 如果遇到 CORS 問題可保留，但可能無法讀取回傳值
                    body: JSON.stringify(data)
                });

                // 注意：若使用 no-cors，fetch 無法取得 response body
                // 以下程式碼假設你的 Google Script 已處理好 CORS 並能正常回傳
                const result = await response.json();

                if (result.result === "ok") {
                    msg.style.color = "green";
                    msg.innerText = "✅ 已成功存入！判斷結果：" + (result.status || "無回傳");
                    
                    // 清空輸入框
                    document.getElementById("sys").value = "";
                    document.getElementById("dia").value = "";
                    document.getElementById("pulse").value = "";
                } else {
                    msg.style.color = "red";
                    msg.innerText = "❌ 存入失敗：" + result.message;
                }

            } catch (error) {
                msg.style.color = "orange";
                msg.innerText = "⚠️ 資料已送出，但無法讀取回傳結果（請至試算表確認）。";
                console.error("Error:", error);
            }
        }
    </script>
</body>
</html>
